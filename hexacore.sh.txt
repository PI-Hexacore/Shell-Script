#!/bin/bash

# ==============================================
# SCRIPT DE AUTOMAÃ‡ÃƒO HEXACORE (BACK + DB + FRONT)
# ==============================================

echo "============================="
echo " Iniciando Setup da Hexacore "
echo "============================="

# -----------------------------
# 1. Verifica se o Git estÃ¡ instalado
# -----------------------------
git --version > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Git nÃ£o encontrado. Instalando..."
  sudo apt update
  sudo apt install git -y
fi

# -----------------------------
# 2. Verifica e instala Java + Maven (para backend)
# -----------------------------
java -version > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Java nÃ£o estÃ¡ instalado. Instalando Java + Maven..."
  sudo apt update
  sudo apt install openjdk-21-jre maven -y
fi

# -----------------------------
# 3. Verifica e instala Node.js + npm (para frontend)
# -----------------------------
node -v > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Node.js nÃ£o estÃ¡ instalado. Instalando..."
  sudo apt update
  sudo apt install nodejs npm -y
fi

# -----------------------------
# 4. Verifica Docker
# -----------------------------
docker --version > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Docker nÃ£o estÃ¡ instalado. Instalando Docker..."
  sudo apt update
  sudo apt install docker.io -y
  sudo systemctl start docker
  sudo systemctl enable docker
fi

# -----------------------------
# 5. PermissÃ£o Docker
# -----------------------------
if ! groups $USER | grep -q '\bdocker\b'; then
  echo "Adicionando usuÃ¡rio ao grupo Docker..."
  sudo usermod -aG docker $USER
  echo "âš ï¸ Saia e entre novamente no sistema, depois rode o script de novo."
  exit 0
fi

# -----------------------------
# 6. Clona ou atualiza os repositÃ³rios
# -----------------------------
BASE_DIR=Hexacore_Project
mkdir -p $BASE_DIR
cd $BASE_DIR

echo "ðŸ“¦ Verificando repositÃ³rios..."

update_or_clone() {
  local REPO_URL=$1
  local FOLDER_NAME=$2

  if [ -d "$FOLDER_NAME/.git" ]; then
    echo "ðŸ”„ Atualizando $FOLDER_NAME..."
    cd $FOLDER_NAME
    git pull
    cd ..
  else
    echo "â¬‡ï¸ Clonando $FOLDER_NAME..."
    git clone $REPO_URL
  fi
}

update_or_clone "https://github.com/PI-Hexacore/Java" "Java"
update_or_clone "https://github.com/PI-Hexacore/BdHexacore" "BdHexacore"
update_or_clone "https://github.com/PI-Hexacore/Site_Hexacore" "Site_Hexacore"

echo "âœ… RepositÃ³rios sincronizados!"


# -----------------------------
# 7. Banco de Dados â€” Criar container do zero
# -----------------------------
CONTAINER_DB="hexacore-db"
DB_ROOT_PASS="142536"
DB_NAME="hexacore"

echo "ðŸ¬ Criando banco de dados do zero..."

# Remove container antigo se existir
docker stop $CONTAINER_DB 2>/dev/null
docker rm $CONTAINER_DB 2>/dev/null

# Cria o container MySQL do zero
docker run -d \
  --name $CONTAINER_DB \
  -e MYSQL_ROOT_PASSWORD=$DB_ROOT_PASS \
  -e MYSQL_DATABASE=$DB_NAME \
  -p 3306:3306 \
  mysql:8.0

echo "âœ… Banco de dados criado e rodando!"


# -----------------------------
# 8. Backend (Java + Maven em Docker)
# -----------------------------

BACKEND_CONTAINER="hexacore-backend"
BACKEND_IMAGE="hexacore-backend-img"
BACKEND_DIR="$PWD/Java/Hexacore-backend-java"

echo "ðŸ›  Preparando backend dentro de container..."

cd "$BACKEND_DIR"

# Remover container antigo
docker stop $BACKEND_CONTAINER 2>/dev/null
docker rm $BACKEND_CONTAINER 2>/dev/null

# Remover imagem antiga
docker rmi $BACKEND_IMAGE 2>/dev/null || true

# Criar Dockerfile caso nÃ£o exista
if [ ! -f Dockerfile ]; then
cat <<EOF > Dockerfile
# Etapa 1: Build com Maven
FROM maven:3.9.6-eclipse-temurin-21 AS build
WORKDIR /app
COPY . . 
RUN mvn clean package -DskipTests

# Etapa 2: Executar a aplicaÃ§Ã£o
FROM eclipse-temurin:21-jre
WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8080
CMD ["java", "-jar", "app.jar"]
EOF
fi

echo "ðŸ“¦ Construindo imagem do backend..."
docker build -t $BACKEND_IMAGE .

echo "ðŸš€ Subindo container do backend..."
docker run -d \
  --name $BACKEND_CONTAINER \
  -p 8080:8080 \
  --restart always \
  $BACKEND_IMAGE

echo "âœ… Backend rodando no container!"


# -----------------------------
# 9. FRONTEND â€” Docker build local (sem Docker Hub)
# -----------------------------
CONTAINER_FRONT="hexacore-site"
IMAGE_FRONT="hexacore-site-img"

echo "ðŸŒ Criando imagem Docker do frontend localmente..."

FRONTEND_DIR="$PWD/../../Site_Hexacore"

cd "$FRONTEND_DIR"

# Verifica se o build estÃ¡ configurado corretamente no package.json
if ! grep -q '"build"' package.json; then
  echo "Script 'build' nÃ£o encontrado no package.json. Adicionando..."
  # Adiciona o script de build se ele nÃ£o estiver presente
  jq '.scripts.build = "react-scripts build"' package.json > temp.json && mv temp.json package.json
fi

# Remover container antigo
docker stop $CONTAINER_FRONT 2>/dev/null
docker rm $CONTAINER_FRONT 2>/dev/null
docker rmi $IMAGE_FRONT 2>/dev/null || true

# Criar Dockerfile se nÃ£o existir
if [ ! -f Dockerfile ]; then
cat <<EOF > Dockerfile
FROM node:18 AS build
WORKDIR /app
COPY . . 
RUN npm install
RUN npm run build

FROM nginx:latest
COPY --from=build /app/build /usr/share/nginx/html
EOF
fi

# Build da imagem
echo "ðŸ“¦ Construindo imagem do frontend..."
docker build -t $IMAGE_FRONT .

# Criar container
echo "ðŸš€ Criando container do frontend..."
docker run -d --name $CONTAINER_FRONT -p 80:80 $IMAGE_FRONT

echo "âœ… Frontend rodando!"


# -----------------------------
# 10. Resumo final
# -----------------------------
echo ""
echo "=========================================="
echo "ðŸš€ Setup concluÃ­do com sucesso!"
echo "Banco de Dados: rodando na porta 3306"
echo "Backend: rodando na porta 8080"
echo "Frontend: rodando na porta 80"
echo "=========================================="
