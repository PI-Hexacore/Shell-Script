#!/bin/bash

# ==============================================
# SCRIPT DE AUTOMA√á√ÉO HEXACORE (BACK + DB + FRONT)
# ==============================================

echo "============================="
echo " Iniciando Setup da Hexacore "
echo "============================="

# -----------------------------
# 1. Verifica se o Git est√° instalado
# -----------------------------
git --version > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Git n√£o encontrado. Instalando..."
  sudo apt update
  sudo apt install git -y
fi

# -----------------------------
# 2. Verifica e instala Java + Maven (para backend)
# -----------------------------
java -version > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Java n√£o est√° instalado. Instalando Java + Maven..."
  sudo apt update
  sudo apt install openjdk-21-jre maven -y
fi

# -----------------------------
# 3. Verifica e instala Node.js + npm (para frontend)
# -----------------------------
node -v > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Node.js n√£o est√° instalado. Instalando..."
  sudo apt update
  sudo apt install nodejs npm -y
fi

# -----------------------------
# 4. Verifica Docker
# -----------------------------
docker --version > /dev/null 2>&1
if [ $? != 0 ]; then
  echo "Docker n√£o est√° instalado. Instalando Docker..."
  sudo apt update
  sudo apt install docker.io -y
  sudo systemctl start docker
  sudo systemctl enable docker
fi

# -----------------------------
# 5. Permiss√£o Docker
# -----------------------------
if ! groups $USER | grep -q '\bdocker\b'; then
  echo "Adicionando usu√°rio ao grupo Docker..."
  sudo usermod -aG docker $USER
  echo "‚ö†Ô∏è Saia e entre novamente no sistema, depois rode o script de novo."
  exit 0
fi

# -----------------------------
# 6. Clona ou atualiza os reposit√≥rios
# -----------------------------
BASE_DIR=Hexacore_Project
mkdir -p $BASE_DIR
cd $BASE_DIR

echo "üì¶ Verificando reposit√≥rios..."

update_or_clone() {
  local REPO_URL=$1
  local FOLDER_NAME=$2

  if [ -d "$FOLDER_NAME/.git" ]; then
    echo "üîÑ Atualizando $FOLDER_NAME..."
    cd $FOLDER_NAME
    git pull
    cd ..
  else
    echo "‚¨áÔ∏è Clonando $FOLDER_NAME..."
    git clone $REPO_URL
  fi
}

update_or_clone "https://github.com/PI-Hexacore/Java" "Java"
update_or_clone "https://github.com/PI-Hexacore/BdHexacore" "BdHexacore"
update_or_clone "https://github.com/PI-Hexacore/Site_Hexacore" "Site_Hexacore"

echo "‚úÖ Reposit√≥rios sincronizados!"


# -----------------------------
# 7. Banco de Dados (Docker Hub)
# -----------------------------

CONTAINER_DB="hexacore-db"
IMAGE_DB="ismaelpaivajr/hexacore_bd:latest"

echo "üê¨ Atualizando imagem do banco de dados..."
docker pull $IMAGE_DB

echo "üîç Verificando container do banco..."

if docker ps -a --format '{{.Names}}' | grep -w "$CONTAINER_DB" > /dev/null; then
  echo "üì¶ Container do banco j√° existe."

  if docker ps --format '{{.Names}}' | grep -w "$CONTAINER_DB" > /dev/null; then
    echo "‚öôÔ∏è Container est√° rodando. Reiniciando com nova imagem..."
    docker stop $CONTAINER_DB
    docker rm $CONTAINER_DB
    docker run -d --name $CONTAINER_DB -p 3306:3306 $IMAGE_DB
  else
    echo "‚ñ∂Ô∏è Container parado. Removendo e recriando..."
    docker rm $CONTAINER_DB
    docker run -d --name $CONTAINER_DB -p 3306:3306 $IMAGE_DB
  fi
else
  echo "‚¨áÔ∏è Container n√£o existe. Criando..."
  docker run -d --name $CONTAINER_DB -p 3306:3306 $IMAGE_DB
fi

echo "‚úÖ Banco de dados atualizado e rodando!"

# -----------------------------
# 8. Backend (Java + Maven)
# -----------------------------

#!/bin/bash
set -e

# Caminho do projeto Java
PROJECT_DIR="/home/ubuntu/Shell-Script/Hexacore_Project/Java/Hexacore-backend-java"
cd "$PROJECT_DIR"

echo "üõ† Construindo o backend..."
mvn clean package -DskipTests

# Pegar o JAR mais recente da pasta target
JAR_FILE=$(ls -t target/*.jar | head -n 1)

if [ ! -f "$JAR_FILE" ]; then
  echo "‚ùå Nenhum JAR encontrado! Build falhou."
  exit 1
fi

echo "‚úÖ JAR encontrado: $JAR_FILE"

# Matar qualquer processo anterior do mesmo JAR (opcional)
if pgrep -f "Hexacore-backend-java-1.0-SNAPSHOT.jar" > /dev/null; then
  echo "‚ö† Parando inst√¢ncia anterior do backend..."
  pkill -f "Hexacore-backend-java-1.0-SNAPSHOT.jar"
fi

echo "üöÄ Iniciando o backend..."
nohup java -jar "$JAR_FILE" > backend.log 2>&1 &

echo "‚úÖ Backend iniciado com sucesso! Log: $PROJECT_DIR/backend.log"

# -----------------------------
# 9. Frontend (Docker Hub)
# -----------------------------

CONTAINER_FRONT="hexacore-site"
IMAGE_FRONT="ismaelpaivajr/hexacore_site:latest"

echo "üåê Atualizando imagem do frontend..."
docker pull $IMAGE_FRONT

echo "üîç Verificando container do site..."

if docker ps -a --format '{{.Names}}' | grep -w "$CONTAINER_FRONT" > /dev/null; then
  echo "üì¶ Container do site j√° existe."

  if docker ps --format '{{.Names}}' | grep -w "$CONTAINER_FRONT" > /dev/null; then
    echo "‚öôÔ∏è Site est√° rodando. Reiniciando..."
    docker stop $CONTAINER_FRONT
    docker rm $CONTAINER_FRONT
    docker run -d --name $CONTAINER_FRONT -p 3333:80 $IMAGE_FRONT
  else
    echo "‚ñ∂Ô∏è Container parado. Removendo e recriando..."
    docker rm $CONTAINER_FRONT
    docker run -d --name $CONTAINER_FRONT -p 3333:80 $IMAGE_FRONT
  fi
else
  echo "‚¨áÔ∏è Container n√£o existe. Criando..."
  docker run -d --name $CONTAINER_FRONT -p 3333:80 $IMAGE_FRONT
fi

echo "‚úÖ Frontend atualizado e rodando!"


# -----------------------------
# 10. Resumo final
# -----------------------------
echo ""
echo "=========================================="
echo "üöÄ Setup conclu√≠do com sucesso!"
echo "Banco de Dados: rodando na porta 3306"
echo "Backend: rodando na porta 8080"
echo "Frontend: rodando na porta 80"
echo "=========================================="
